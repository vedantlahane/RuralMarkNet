{% extends "base.html" %}
{% load i18n l10n %}

{% block title %}{% blocktrans %}Delivery for order #{{ delivery.order_id }}{% endblocktrans %}{% endblock %}

{% block content %}
<section class="space-y-8">
    <header class="flex flex-col gap-4 rounded-3xl bg-white p-6 shadow-lg ring-1 ring-emerald-50 sm:flex-row sm:items-center sm:justify-between">
        <div>
            <p class="text-sm font-semibold uppercase tracking-wide text-emerald-600">{% trans "Delivery" %}</p>
            <h1 class="text-3xl font-semibold text-slate-900">{% blocktrans %}Delivery for order #{{ delivery.order_id }}{% endblocktrans %}</h1>
        </div>
        <span class="inline-flex items-center justify-center rounded-full bg-emerald-50 px-4 py-2 text-sm font-semibold text-emerald-600">{{ delivery.get_status_display }}</span>
    </header>

    <div class="grid gap-6 md:grid-cols-2">
        <article class="rounded-3xl bg-white p-6 shadow-lg ring-1 ring-emerald-50">
            <h2 class="text-lg font-semibold text-slate-900">{% trans "Order overview" %}</h2>
            <dl class="mt-4 grid gap-3 text-sm text-slate-600">
                <div class="flex items-center justify-between">
                    <dt class="text-slate-500">{% trans "Order status" %}</dt>
                    <dd class="font-semibold text-slate-800">{{ delivery.order.get_status_display }}</dd>
                </div>
                <div class="flex items-center justify-between">
                    <dt class="text-slate-500">{% trans "Payment status" %}</dt>
                    <dd class="font-semibold text-slate-800">{{ delivery.order.get_payment_status_display }}</dd>
                </div>
                <div class="flex items-center justify-between">
                    <dt class="text-slate-500">{% trans "Customer" %}</dt>
                    <dd class="font-medium">
                        {{ delivery.order.customer.get_full_name|default:delivery.order.customer.username }}
                    </dd>
                </div>
                <div class="flex items-center justify-between">
                    <dt class="text-slate-500">{% trans "Assigned farmer" %}</dt>
                    <dd class="font-medium">
                        {% if delivery.assigned_farmer %}
                            {{ delivery.assigned_farmer.get_full_name|default:delivery.assigned_farmer.username }}
                        {% else %}
                            {% trans "Not assigned" %}
                        {% endif %}
                    </dd>
                </div>
                <div class="flex items-center justify-between">
                    <dt class="text-slate-500">{% trans "Total" %}</dt>
                    <dd class="font-semibold text-slate-800">{{ delivery.order.total_amount|localize }}</dd>
                </div>
            </dl>
        </article>

        <article class="rounded-3xl bg-white p-6 shadow-lg ring-1 ring-emerald-50">
            <h2 class="text-lg font-semibold text-slate-900">{% trans "Schedule & logistics" %}</h2>
            <dl class="mt-4 grid gap-3 text-sm text-slate-600">
                <div>
                    <dt class="text-slate-500">{% trans "Scheduled for" %}</dt>
                    <dd class="mt-1 font-medium text-slate-800">
                        {% if delivery.order.scheduled_date %}
                            {{ delivery.order.scheduled_date|date:"SHORT_DATE_FORMAT" }}
                            {% if delivery.order.scheduled_window %}
                                Â· {{ delivery.order.scheduled_window }}
                            {% endif %}
                        {% else %}
                            {% trans "Not scheduled" %}
                        {% endif %}
                    </dd>
                </div>
                <div>
                    <dt class="text-slate-500">{% trans "Delivery address" %}</dt>
                    <dd class="mt-1 font-medium text-slate-800">
                        {% if delivery.order.delivery_address %}
                            {{ delivery.order.delivery_address|linebreaksbr }}
                        {% else %}
                            {% trans "No delivery address provided" %}
                        {% endif %}
                    </dd>
                </div>
                <div class="grid gap-1 sm:grid-cols-2">
                    <div>
                        <dt class="text-slate-500">{% trans "Driver" %}</dt>
                        <dd class="mt-1 font-medium text-slate-800">{{ delivery.driver_name|default:_('Not assigned') }}</dd>
                    </div>
                    <div>
                        <dt class="text-slate-500">{% trans "Contact number" %}</dt>
                        <dd class="mt-1 font-medium text-slate-800">
                            {% if delivery.contact_number %}
                                {{ delivery.contact_number }}
                            {% elif delivery.assigned_farmer and delivery.assigned_farmer.phone_number %}
                                {{ delivery.assigned_farmer.phone_number }}
                            {% else %}
                                {% trans "Not provided" %}
                            {% endif %}
                        </dd>
                    </div>
                </div>
                <div class="flex items-center justify-between">
                    <dt class="text-slate-500">{% trans "Last updated" %}</dt>
                    <dd class="font-medium text-slate-800">{{ delivery.updated_at|date:"SHORT_DATETIME_FORMAT" }}</dd>
                </div>
            </dl>
        </article>
    </div>

    <article class="rounded-3xl bg-white p-6 shadow-lg ring-1 ring-emerald-50">
        <h2 class="text-lg font-semibold text-slate-900">{% trans "Items" %}</h2>
        {% with items=delivery.order.items.all %}
            {% if items %}
                <div class="mt-4 overflow-hidden rounded-2xl border border-emerald-100">
                    <table class="min-w-full divide-y divide-emerald-100 text-sm text-slate-600">
                        <thead class="bg-emerald-50 text-left text-xs font-semibold uppercase tracking-wide text-emerald-700">
                            <tr>
                                <th scope="col" class="px-4 py-3">{% trans "Product" %}</th>
                                <th scope="col" class="px-4 py-3 text-right">{% trans "Quantity" %}</th>
                                <th scope="col" class="px-4 py-3 text-right">{% trans "Unit price" %}</th>
                                <th scope="col" class="px-4 py-3 text-right">{% trans "Line total" %}</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-emerald-100">
                            {% for item in items %}
                                <tr>
                                    <td class="px-4 py-3 font-medium text-slate-800">{{ item.product.name }}</td>
                                    <td class="px-4 py-3 text-right">{{ item.quantity }}</td>
                                    <td class="px-4 py-3 text-right">{{ item.price|localize }}</td>
                                    <td class="px-4 py-3 text-right">{{ item.line_total|localize }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="mt-4 text-sm text-slate-500">{% trans "No items have been added to this order yet." %}</p>
            {% endif %}
        {% endwith %}
    </article>

    {% if delivery.order.notes %}
        <article class="rounded-3xl bg-white p-6 shadow-lg ring-1 ring-emerald-50">
            <h2 class="text-lg font-semibold text-slate-900">{% trans "Customer notes" %}</h2>
            <p class="mt-3 whitespace-pre-line text-sm text-slate-600">{{ delivery.order.notes }}</p>
        </article>
    {% endif %}

    {% if user.is_farmer and delivery.assigned_farmer_id == user.id %}
        {% with update_route=update_url_name|default:'deliveries:update' %}
            <a href="{% url update_route delivery.pk %}" class="inline-flex w-full items-center justify-center rounded-full bg-emerald-600 px-5 py-3 text-sm font-semibold text-white shadow-lg shadow-emerald-200 transition hover:bg-emerald-500 md:w-auto">{% trans "Update delivery" %}</a>
        {% endwith %}
    {% endif %}
</section>
{% endblock %}
